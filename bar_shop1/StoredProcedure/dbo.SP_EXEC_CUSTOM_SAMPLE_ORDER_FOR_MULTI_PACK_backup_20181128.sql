IF OBJECT_ID (N'dbo.SP_EXEC_CUSTOM_SAMPLE_ORDER_FOR_MULTI_PACK_backup_20181128', N'P') IS NOT NULL DROP PROCEDURE dbo.SP_EXEC_CUSTOM_SAMPLE_ORDER_FOR_MULTI_PACK_backup_20181128
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

/*

SELECT	STUFF	
		(
			(
				SELECT	',' + CAST(SAMPLE_ORDER_SEQ AS VARCHAR(10))
				FROM	CUSTOM_SAMPLE_ORDER
				WHERE	CONVERT(VARCHAR(10), REQUEST_DATE, 120) = CONVERT(VARCHAR(10), CSO.REQUEST_DATE, 120)
				FOR XML PATH('')
			)	
		, 1, 1, '') AS SAMPLE_ORDER_SEQ_LIST
FROM	CUSTOM_SAMPLE_ORDER CSO
WHERE	1 = 1
AND		REQUEST_DATE >= '2017-08-01 00:00:00' 
AND		REQUEST_DATE < '2017-08-02 00:00:00'
GROUP BY CONVERT(VARCHAR(10), REQUEST_DATE, 120)


EXEC SP_EXEC_CUSTOM_SAMPLE_ORDER_FOR_MULTI_PACK '1326316,1326317,1326318,1326319,1326321,1326320,1326322,1326323,1326324,1326325,1326326,1326327,1326328,1326329,1326331,1326330,1326332,1326333,1326334,1326335,1326337,1326336,1326338,1326339,1326340,1326341,1326342,1326343,1326344,1326345,1326346,1326347,1326348,1326349,1326350,1326351,1326352,1326353,1326354,1326355,1326356,1326357,1326358,1326359,1326360,1326361,1326362,1326363,1326364,1326365,1326366,1326367,1326368,1326369,1326370,1326371,1326372,1326373,1326374,1326375,1326376,1326377,1326378,1326379,1326380,1326381,1326382,1326383,1326384,1326385,1326386,1326387,1326389,1326388,1326390,1326391,1326392,1326393,1326394,1326395,1326396,1326397,1326398,1326399,1326400,1326401,1326402,1326403,1326404,1326405,1326406,1326407,1326408,1326409,1326410,1326411,1326412,1326413,1326414,1326415,1326416,1326417,1326418,1326419,1326420,1326421,1326422,1326423,1326424,1326425,1326426,1326427,1326428,1326429,1326430,1326431,1326432,1326433,1326434,1326435,1326436,1326437,1326438,1326439,1326441,1326440,1326442,1326443,1326444,1326445,1326446,1326447,1326449,1326448,1326450,1326451,1326452,1326453,1326454,1326455,1326456,1326457,1326458,1326459,1326461,1326462,1326463,1326464,1326465,1326466,1326467,1326468,1326469,1326470,1326471,1326472,1326473,1326474,1326475,1326478,1326476,1326479,1326477,1326480,1326481,1326483,1326482,1326485,1326486,1326487,1326484,1326488,1326489,1326490,1326491,1326492,1326493,1326494,1326495,1326496,1326497,1326499,1326498,1326501,1326502,1326500,1326503,1326504,1326505,1326506,1326507,1326508,1326511,1326510,1326509,1326512,1326513,1326514,1326515,1326516,1326518,1326517,1326520,1326519,1326521,1326522,1326523,1326524,1326525,1326526,1326527,1326528,1326529,1326530,1326531,1326532,1326533,1326534,1326535,1326537,1326536,1326538,1326539,1326540,1326541,1326542,1326543,1326544,1326545,1326546,1326547,1326548,1326549,1326551,1326550,1326552,1326553,1326554,1326555,1326556,1326557,1326558,1326559,1326560,1326561,1326562,1326563,1326564,1326565,1326566,1326567,1326568,1326569,1326570,1326571,1326572,1326573,1326574,1326575,1326576,1326577,1326578,1326580,1326579,1326581,1326582,1326583,1326584,1326585,1326586,1326587,1326588,1326589,1326590,1326591,1326592,1326593,1326594,1326595,1326596,1326597,1326598,1326600,1326599,1326601,1326602,1326603,1326604,1326605,1326606,1326607,1326608,1326609,1326610,1326611,1326612,1326613,1326614,1326615,1326616,1326617,1326618,1326619,1326620,1326621,1326622,1326623,1326624,1326625,1326627,1326628,1326629,1326630,1326631,1326632,1326633,1326634,1326635,1326636,1326637,1326638,1326639,1326640,1326626,1326641,1326642,1326643,1326644,1326646,1326645,1326647,1326649,1326651,1326650,1326648,1326652,1326653,1326654,1326655,1326656,1326657,1326658,1326659,1326660,1326661,1326662,1326664,1326665,1326663,1326666,1326667,1326668,1326669,1326670,1326671,1326672,1326673,1326674,1326675,1326676,1326677,1326678,1326679,1326680,1326681,1326682,1326683,1326684,1326685,1326686,1326687,1326688,1326689,1326690,1326691,1326692,1326693,1326694,1326695,1326696,1326697,1326698,1326700,1326699,1326701,1326702,1326703,1326704,1326705,1326706,1326708,1326707,1326709,1326710,1326712,1326711,1326713,1326714,1326715,1326716,1326717,1326718,1326719,1326720,1326721,1326722,1326723,1326724,1326725,1326726,1326728,1326727,1326729,1326730,1326731,1326732,1326733,1326734,1326735,1326736,1326737,1326738,1326740,1326739,1326741,1326742,1326744,1326743,1326745,1326746,1326747,1326748,1326749,1326750,1326751,1326752,1326755,1326753,1326754,1326756,1326758,1326757,1326759,1326760,1326761,1326762,1326763,1326764,1326765,1326766,1326767,1326769,1326768,1326770,1326771,1326772,1326773,1326774,1326775,1326776,1326777,1326779,1326778,1326780,1326781,1326782,1326783,1326784,1326785,1326786,1326787,1326788,1326789,1326790,1326791,1326792,1326793,1326794,1326795,1326796,1326797,1326798,1326799,1326800,1326801,1326802,1326803,1326804,1326805,1326806,1326807,1326808,1326809,1326810,1326811,1326812,1326813,1326814,1326815,1326816,1326817,1326818,1326820,1326819,1326821,1326822,1326823,1326824,1326825,1326826,1326827,1326828,1326829,1326830,1326831,1326832,1326834,1326835,1326833,1326837,1326836,1326838,1326839,1326840,1326841,1326842,1326843,1326844,1326845,1326846,1326847,1326848,1326849,1326850,1326851,1326852,1326853,1326854,1326855,1326856,1326857,1326858,1326859,1326860,1326861,1326863,1326862,1326864,1326866,1326865,1326867,1326868,1326869,1326870,1326871,1326872,1326874,1326873,1326875,1326876,1326877,1326878,1326879,1326880,1326881,1326882,1326883,1326884,1326885,1326887,1326886,1326888,1326889,1326890,1326891,1326892,1326893,1326894,1326895,1326896,1326897,1326898,1326899,1326900,1326903,1326904,1326902,1326901,1326905,1326906,1326907,1326908,1326909,1326910,1326911'

*/

CREATE PROCEDURE [dbo].[SP_EXEC_CUSTOM_SAMPLE_ORDER_FOR_MULTI_PACK_backup_20181128]
    @P_SAMPLE_ORDER_SEQ_LIST			AS VARCHAR(MAX)

AS
BEGIN
    
    SET NOCOUNT ON;

	-- 해당일의 마지막 시퀀스 가져오기
	DECLARE @LAST_MULTI_PACK_SEQ AS INT 
	SET @LAST_MULTI_PACK_SEQ = ISNULL	(
											(
												SELECT	MAX(MULTI_PACK_SEQ) 
												FROM	CUSTOM_SAMPLE_ORDER 
												WHERE	CONVERT(VARCHAR(10), MULTI_PACK_REG_DATE, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)
											)
										, 100)
	
	UPDATE	CUSTOM_SAMPLE_ORDER
	SET		MEMBER_FAX = CONVERT(VARCHAR(10), GETDATE(), 120) + '-' + CAST(MP.MULTI_PACK_SEQ AS VARCHAR(10)) + '-' + CAST(MP.MULTI_PACK_SUB_SEQ AS VARCHAR(10))
		,	MULTI_PACK_SEQ = MP.MULTI_PACK_SEQ
		,	MULTI_PACK_SUB_SEQ = MP.MULTI_PACK_SUB_SEQ
		,	MULTI_PACK_REG_DATE = GETDATE()

	FROM	CUSTOM_SAMPLE_ORDER CSO
	JOIN	(
				SELECT	@LAST_MULTI_PACK_SEQ + B.RANKING AS MULTI_PACK_SEQ
					,	B.SEQ AS MULTI_PACK_SUB_SEQ
					,	B.SAMPLE_ORDER_SEQ
				FROM	(
							SELECT	DENSE_RANK() OVER(ORDER BY ADDRESS ASC) RANKING
								,	A.SEQ
								,	A.SAMPLE_ORDER_SEQ
							FROM	(
										SELECT	
												ROW_NUMBER() OVER (
													PARTITION BY REPLACE(MEMBER_ADDRESS, ' ', '') + REPLACE(MEMBER_ADDRESS_DETAIL, ' ', '') 
													ORDER BY 
														CASE 
																WHEN SALES_GUBUN = 'SB' THEN 1 
																WHEN SALES_GUBUN = 'SA' THEN 2
																WHEN SALES_GUBUN = 'ST' THEN 3 
																WHEN SALES_GUBUN = 'SS' THEN 4
																ELSE 5
														END
														ASC
												) 
												AS SEQ
					
											,	COUNT(*) OVER(PARTITION BY REPLACE(MEMBER_ADDRESS, ' ', '') + REPLACE(MEMBER_ADDRESS_DETAIL, ' ', '')) 
												AS CNT

											,	SAMPLE_ORDER_SEQ AS SAMPLE_ORDER_SEQ
											,	REPLACE(MEMBER_ADDRESS, ' ', '') + REPLACE(MEMBER_ADDRESS_DETAIL, ' ', '') AS ADDRESS

										FROM	CUSTOM_SAMPLE_ORDER
										WHERE	1 = 1
										AND		STATUS_SEQ = 4

										-- 묶음 처리 대상 사이트는 바비더프 (제휴 제외)
										AND		SALES_GUBUN IN ('SB', 'SA', 'ST', 'SS')

										-- 주소가 공백이 아니어야 하고,
										AND		ISNULL(REPLACE(MEMBER_ADDRESS, ' ', '') + REPLACE(MEMBER_ADDRESS_DETAIL, ' ', ''), '') <> ''
										-- 주소의 길이가 최소 10 이상
										AND		LEN(ISNULL(REPLACE(MEMBER_ADDRESS, ' ', '') + REPLACE(MEMBER_ADDRESS_DETAIL, ' ', ''), '')) >= 10
										
										AND		SAMPLE_ORDER_SEQ IN (SELECT VALUE FROM FN_SPLIT(REPLACE(@P_SAMPLE_ORDER_SEQ_LIST, ' ', ''), ','))
										--AND		REQUEST_DATE >= '2017-09-13 00:00:00'
									) A

							WHERE	1 = 1
							AND		A.CNT > 1
						) B
			) MP ON CSO.SAMPLE_ORDER_SEQ = MP.SAMPLE_ORDER_SEQ


	
END




GO
