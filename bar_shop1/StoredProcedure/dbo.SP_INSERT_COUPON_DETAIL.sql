IF OBJECT_ID (N'dbo.SP_INSERT_COUPON_DETAIL', N'P') IS NOT NULL DROP PROCEDURE dbo.SP_INSERT_COUPON_DETAIL
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*

EXEC SP_INSERT_COUPON_DETAIL 6, 20

EXEC SP_INSERT_COUPON_DETAIL 6, 0, 'ASDF-1234-5678-9012|ASDF-1234-5678-9013|ASDF-1234-5678-9014|ASDF-1234-5678-9015|ASDF-1234-5678-9016|ASDF-1234-5678-9017|ASDF-1234-5678-9018|ASDF-1234-5678-9019|ASDF-1234-5678-9020|ASDF-1234-5678-9021|ASDF-1234-5678-9022|ASDF-1234-5678-9023|ASDF-1234-5678-9024|ASDF-1234-5678-9025|ASDF-1234-5678-9026|ASDF-1234-5678-9027|ASDF-1234-5678-9028|ASDF-1234-5678-9029|ASDF-1234-5678-9030|ASDF-1234-5678-9031|ASDF-1234-5678-9032|ASDF-1234-5678-9033|ASDF-1234-5678-9034|ASDF-1234-5678-9035|ASDF-1234-5678-9036|ASDF-1234-5678-9037|ASDF-1234-5678-9038|ASDF-1234-5678-9039|ASDF-1234-5678-9040|ASDF-1234-5678-9041'

*/

CREATE PROCEDURE [dbo].[SP_INSERT_COUPON_DETAIL]
		@P_COUPON_MST_SEQ					AS INT
	,	@P_QNT								AS INT
	,	@P_COUPON_CODE_LIST					AS VARCHAR(MAX)

AS
BEGIN
	
	SET NOCOUNT ON;

	IF @P_COUPON_CODE_LIST = ''
	BEGIN
		
		/* 임의 생성 */

		--WHILE @P_QNT > 0
		--BEGIN
		
		--	INSERT INTO COUPON_DETAIL (COUPON_MST_SEQ, COUPON_CODE, DOWNLOAD_ACTIVE_YN)
		--	SELECT	@P_COUPON_MST_SEQ
		--		,	NEWID()
		--		,	'Y'

		--	SET @P_QNT = @P_QNT - 1
		--END

		/* WHILE 문을 사용하지 않고, 한번에 INSERT 시키기 위해서 임의의 테이블을 사용 */
		INSERT INTO COUPON_DETAIL (COUPON_MST_SEQ, COUPON_CODE, DOWNLOAD_ACTIVE_YN)

		SELECT	@P_COUPON_MST_SEQ
			,	LEFT(RIGHT(NEWID(), 32), 19)
			,	'Y'

		FROM	S2_USERINFO
		ORDER BY REG_DATE ASC
		OFFSET 0 ROWS
		FETCH NEXT @P_QNT ROW ONLY

	END

	ELSE
	BEGIN
		
		/* 파일 등록 */
		INSERT INTO COUPON_DETAIL (COUPON_MST_SEQ, COUPON_CODE, DOWNLOAD_ACTIVE_YN)

		SELECT	DISTINCT @P_COUPON_MST_SEQ
			,	VALUE
			,	'Y'

		FROM	dbo.[FN_SPLIT] (@P_COUPON_CODE_LIST, '|')
		WHERE	VALUE NOT IN	(
									SELECT COUPON_CODE FROM COUPON_DETAIL WHERE @P_COUPON_MST_SEQ = @P_COUPON_MST_SEQ
								)

	END


END

GO
